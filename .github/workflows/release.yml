name: Create Datapack Release

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag name (e.g., v1.0.0 or 1.0.0)"
        required: true
        type: string
      versions:
        description: |
          Minecraft versions.
          Examples:
            1.21.9
            1.21.9-1.21.11
            1.21.7,1.21.9-1.21.11
        required: true
        type: string

permissions:
  contents: write

jobs:
  normalize-tag:
    runs-on: ubuntu-22.04
    outputs:
      base_version: ${{ steps.out.outputs.base_version }}
      full_tag: ${{ steps.out.outputs.full_tag }}
    steps:
      - id: out
        run: |
          inp="${{ github.event.inputs.tag }}"
          [[ "$inp" =~ ^v ]] || inp="v$inp"
          echo "base_version=${inp#v}" >> "$GITHUB_OUTPUT"
          echo "full_tag=$inp" >> "$GITHUB_OUTPUT"

  prepare-versions:
    runs-on: ubuntu-22.04
    outputs:
      mc_versions: ${{ steps.out.outputs.mc_versions }}
    steps:
      - id: out
        run: |
          set -e
          INPUT="$(echo "${{ github.event.inputs.versions }}" | tr -d ' ')"

          expand() {
            local a="$1" b="$2"
            [[ "${a%.*}" == "${b%.*}" ]] || exit 1
            for ((i=${a##*.}; i<=${b##*.}; i++)); do
              echo "${a%.*}.$i"
            done
          }

          OUT=()
          IFS=',' read -ra PARTS <<< "$INPUT"
          for p in "${PARTS[@]}"; do
            if [[ "$p" == *-* ]]; then
              while read -r v; do OUT+=("$v"); done < <(
                expand "${p%%-*}" "${p##*-}"
              )
            else
              OUT+=("$p")
            fi
          done

          {
            echo "mc_versions<<EOF"
            for v in "${OUT[@]}"; do echo "$v"; done
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

  build-zip:
    runs-on: ubuntu-22.04
    needs: normalize-tag
    outputs:
      zip_name: ${{ steps.zip.outputs.archive_name }}
    steps:
      - uses: actions/checkout@v4

      - id: zip
        run: |
          set -e
          REPO_NAME="${GITHUB_REPOSITORY#*/}"
          ZIP="${REPO_NAME}-${{ needs.normalize-tag.outputs.base_version }}.zip"

          [ -f pack.mcmeta ] || { echo "::error ::pack.mcmeta not found at repo root"; exit 1; }

          rm -f "$ZIP"
          zip -r "$ZIP" pack.mcmeta
          [ -d data ] && zip -r "$ZIP" data
          [ -d assets ] && zip -r "$ZIP" assets
          [ -f pack.png ] && zip -u "$ZIP" pack.png

          echo "::group::ZIP CONTENTS"
          unzip -l "$ZIP"
          echo "::endgroup::"

          echo "archive_name=$ZIP" >> "$GITHUB_OUTPUT"

      - uses: actions/upload-artifact@v4
        with:
          name: datapack
          path: ${{ steps.zip.outputs.archive_name }}

  generate-changelog:
    runs-on: ubuntu-22.04
    needs: normalize-tag
    outputs:
      CHANGELOG: ${{ steps.out.outputs.CHANGELOG }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - id: out
        run: |
          TAG="${{ needs.normalize-tag.outputs.full_tag }}"
          REPO_NAME="${GITHUB_REPOSITORY#*/}"

          # Get previous tag (fallback to initial commit)
          git fetch --tags
          PREV_TAG=$(git tag --sort=-v:refname | sed -n '2p' || echo $(git rev-list --max-parents=0 HEAD))
          CHANGELOG="**Full Changelog**: https://github.com/${REPO_NAME}/compare/${PREV_TAG}...${TAG}"

          echo "CHANGELOG=$CHANGELOG" >> "$GITHUB_OUTPUT"

  release:
    runs-on: ubuntu-22.04
    needs: [normalize-tag, prepare-versions, build-zip, generate-changelog]
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: datapack

      - name: Publish GitHub & Modrinth release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MODRINTH_TOKEN: ${{ secrets.MODRINTH_TOKEN }}
        run: |
          REPO_NAME="${GITHUB_REPOSITORY#*/}"
          VERSION="${{ needs.normalize-tag.outputs.base_version }}"
          TAG="${{ needs.normalize-tag.outputs.full_tag }}"
          VERSIONS="${{ github.event.inputs.versions }}"
          ZIP_FILE="${{ needs.build-zip.outputs.zip_name }}"
          CHANGELOG="${{ needs.generate-changelog.outputs.CHANGELOG }}"

          # Convert multi-line MC versions to comma-separated for Modrinth
          GAME_VERSIONS=$(echo "${{ needs.prepare-versions.outputs.mc_versions }}" | tr '\n' ',' | sed 's/,$//')

          # Single GitHub release
          gh release create "$TAG" \
            --repo="$GITHUB_REPOSITORY" \
            --title="${REPO_NAME} ${TAG} for ${VERSIONS}" \
            --notes "$CHANGELOG" \
            --latest \
            "$ZIP_FILE"

          # Publish to Modrinth using the same changelog
          npx kira-mc-publish@latest \
            --name "$VERSION" \
            --version "$VERSION" \
            --version-type release \
            --files "$ZIP_FILE" \
            --loaders datapack \
            --game-versions "$GAME_VERSIONS" \
            --modrinth-changelog "$CHANGELOG" \
            --modrinth-id "${{ vars.MODRINTH_ID }}" \
            --modrinth-token "$MODRINTH_TOKEN"
