name: Create Datapack Release

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag name (e.g., v1.0.0 or 1.0.0)"
        required: true
        type: string
      versions:
        description: |
          Minecraft versions.
          Examples:
            1.21.9
            1.21.9-1.21.11
            1.21.7,1.21.9-1.21.11
        required: true
        type: string

permissions:
  contents: write

jobs:
  normalize-tag:
    runs-on: ubuntu-22.04
    outputs:
      base_version: ${{ steps.out.outputs.base_version }}
    steps:
      - id: out
        run: |
          inp="${{ github.event.inputs.tag }}"
          [[ "$inp" =~ ^v ]] || inp="v$inp"
          echo "base_version=${inp#v}" >> "$GITHUB_OUTPUT"

  prepare-versions:
    runs-on: ubuntu-22.04
    outputs:
      mc_versions: ${{ steps.out.outputs.mc_versions }}
    steps:
      - id: out
        run: |
          set -e
          INPUT="$(echo "${{ github.event.inputs.versions }}" | tr -d ' ')"

          expand() {
            local a="$1" b="$2"
            [[ "${a%.*}" == "${b%.*}" ]] || exit 1
            for ((i=${a##*.}; i<=${b##*.}; i++)); do
              echo "${a%.*}.$i"
            done
          }

          OUT=()
          IFS=',' read -ra PARTS <<< "$INPUT"
          for p in "${PARTS[@]}"; do
            if [[ "$p" == *-* ]]; then
              while read -r v; do OUT+=("$v"); done < <(
                expand "${p%%-*}" "${p##*-}"
              )
            else
              OUT+=("$p")
            fi
          done

          {
            echo "mc_versions<<EOF"
            for v in "${OUT[@]}"; do echo "$v"; done
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

  build-zip:
    runs-on: ubuntu-22.04
    needs: normalize-tag
    outputs:
      zip_name: ${{ steps.zip.outputs.name }}
    steps:
      - uses: actions/checkout@v4

      - id: zip
        run: |
          set -e
          ZIP="${GITHUB_REPOSITORY#*/}-${{ needs.normalize-tag.outputs.base_version }}.zip"

          # Hard fail if pack.mcmeta is not at repo root
          [ -f pack.mcmeta ] || {
            echo "::error ::pack.mcmeta must be at repository root"
            exit 1
          }

          zip -r "$ZIP" pack.mcmeta
          [ -d data ] && zip -r "$ZIP" data
          [ -d assets ] && zip -r "$ZIP" assets
          [ -f pack.png ] && zip -u "$ZIP" pack.png

          unzip -l "$ZIP" | sed 's/^/  /'
          echo "name=$ZIP" >> "$GITHUB_OUTPUT"

      - uses: actions/upload-artifact@v4
        with:
          name: datapack
          path: ${{ steps.zip.outputs.name }}

  release:
    runs-on: ubuntu-22.04
    needs: [normalize-tag, prepare-versions, build-zip]
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: datapack

      - uses: Kira-NT/mc-publish@v3
        with:
          name: ${{ needs.normalize-tag.outputs.base_version }}
          version: ${{ needs.normalize-tag.outputs.base_version }}
          version-type: release
          changelog: auto
          game-versions: ${{ needs.prepare-versions.outputs.mc_versions }}
          files: ${{ needs.build-zip.outputs.zip_name }}
          loaders: vanilla
          github-token: ${{ secrets.GITHUB_TOKEN }}
          modrinth-token: ${{ secrets.MODRINTH_TOKEN }}
          modrinth-id: ${{ vars.MODRINTH_ID }}
