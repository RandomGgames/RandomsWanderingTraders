name: Create Datapack Release

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag name (e.g., v1.0.0 or 1.0.0)"
        required: true
        type: string
      versions:
        description: |
          Minecraft versions.
          Examples:
            1.21.9
            1.21.9-1.21.11
            1.21.7,1.21.9-1.21.11
        required: true
        type: string

permissions:
  contents: write

jobs:
  normalize-tag:
    runs-on: ubuntu-22.04
    outputs:
      base_version: ${{ steps.out.outputs.base_version }}
      full_tag: ${{ steps.out.outputs.full_tag }}
    steps:
      - id: out
        run: |
          inp="${{ github.event.inputs.tag }}"
          [[ "$inp" =~ ^v ]] || inp="v$inp"
          echo "base_version=${inp#v}" >> "$GITHUB_OUTPUT"
          echo "full_tag=$inp" >> "$GITHUB_OUTPUT"

  prepare-versions:
    runs-on: ubuntu-22.04
    outputs:
      mc_versions: ${{ steps.out.outputs.mc_versions }}
    steps:
      - id: out
        run: |
          set -e
          INPUT="$(echo "${{ github.event.inputs.versions }}" | tr -d ' ')"

          expand() {
            local a="$1" b="$2"
            [[ "${a%.*}" == "${b%.*}" ]] || exit 1
            for ((i=${a##*.}; i<=${b##*.}; i++)); do
              echo "${a%.*}.$i"
            done
          }

          OUT=()
          IFS=',' read -ra PARTS <<< "$INPUT"
          for p in "${PARTS[@]}"; do
            if [[ "$p" == *-* ]]; then
              while read -r v; do OUT+=("$v"); done < <(
                expand "${p%%-*}" "${p##*-}"
              )
            else
              OUT+=("$p")
            fi
          done

          {
            echo "mc_versions<<EOF"
            for v in "${OUT[@]}"; do echo "$v"; done
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

  build-zip:
    runs-on: ubuntu-22.04
    needs: normalize-tag
    outputs:
      zip_name: ${{ steps.zip.outputs.archive_name }}
    steps:
      - uses: actions/checkout@v4

      - id: zip
        run: |
          set -e
          REPO_NAME="${GITHUB_REPOSITORY#*/}"
          ZIP="${REPO_NAME}-${{ needs.normalize-tag.outputs.base_version }}.zip"

          # Ensure required file exists
          [ -f pack.mcmeta ] || { echo "::error ::pack.mcmeta not found at repo root"; exit 1; }

          # Remove old zip and build new one
          rm -f "$ZIP"
          zip -r "$ZIP" pack.mcmeta
          [ -d data ] && zip -r "$ZIP" data
          [ -d assets ] && zip -r "$ZIP" assets
          [ -f pack.png ] && zip -u "$ZIP" pack.png

          echo "::group::ZIP CONTENTS"
          unzip -l "$ZIP"
          echo "::endgroup::"

          echo "archive_name=$ZIP" >> "$GITHUB_OUTPUT"

      - uses: actions/upload-artifact@v4
        with:
          name: datapack
          path: ${{ steps.zip.outputs.archive_name }}

  generate-changelog:
    runs-on: ubuntu-22.04
    needs: normalize-tag
    outputs:
      CHANGELOG: ${{ steps.out.outputs.changelog }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Needed to access tags

      - id: out
        run: |
          set -e
          TAG="${{ needs.normalize-tag.outputs.full_tag }}"

          # Find previous tag
          PREV=$(git tag --sort=-v:refname | grep -v "^${TAG}$" | head -n1)
          [ -z "$PREV" ] && PREV="$TAG"

          # Generate changelog between previous and current tag
          CHANGELOG="**Full Changelog**: https://github.com/${GITHUB_REPOSITORY}/compare/${PREV}...${TAG}"
          echo "changelog=$CHANGELOG" >> "$GITHUB_OUTPUT"

  release:
    runs-on: ubuntu-22.04
    needs: [normalize-tag, prepare-versions, build-zip, generate-changelog]
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: datapack

      - name: Publish to Modrinth and GitHub
        uses: Kira-NT/mc-publish@v3
        with:
          name: ${{ needs.normalize-tag.outputs.base_version }}
          version: ${{ needs.normalize-tag.outputs.base_version }}
          version-type: release

          files: ${{ needs.build-zip.outputs.zip_name }}
          loaders: datapack
          game-versions: ${{ needs.prepare-versions.outputs.mc_versions }}

          # GitHub release customization
          github-name: "${{ github.repository#*/ }} v${{ needs.normalize-tag.outputs.base_version }} for ${{ github.event.inputs.versions }}"
          github-changelog: ${{ needs.generate-changelog.outputs.CHANGELOG }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

          # Modrinth release customization
          modrinth-changelog: ${{ needs.generate-changelog.outputs.CHANGELOG }}
          modrinth-token: ${{ secrets.MODRINTH_TOKEN }}
          modrinth-id: ${{ vars.MODRINTH_ID }}
