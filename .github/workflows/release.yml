name: Create Datapack Release

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag name (e.g., v1.0.0 or 1.0.0)"
        required: true
        type: string
      versions:
        description: |
          One or more compatible Minecraft versions.
          Examples:
            1.21.9
            1.21.9-1.21.11
            1.21.7,1.21.9-1.21.11,1.22
        required: true
        type: string

permissions:
  contents: write

jobs:
  normalize-tag:
    runs-on: ubuntu-22.04
    outputs:
      tag: ${{ steps.out.outputs.tag }}
      base_version: ${{ steps.out.outputs.base_version }}
    steps:
      - id: out
        run: |
          inp="${{ github.event.inputs.tag }}"
          [[ "$inp" =~ ^v ]] && tag="$inp" || tag="v$inp"
          echo "tag=$tag" >> "$GITHUB_OUTPUT"
          echo "base_version=${tag#v}" >> "$GITHUB_OUTPUT"

  prepare-versions:
    runs-on: ubuntu-22.04
    outputs:
      mc_versions: ${{ steps.versions.outputs.mc_versions }}
    steps:
      - id: versions
        run: |
          set -e
          INPUT="$(echo "${{ github.event.inputs.versions }}" | tr -d ' ')"

          expand_range() {
            local start="$1"
            local end="$2"

            [[ "${start%.*}" == "${end%.*}" ]] || {
              echo "::error ::Invalid range: $start-$end"
              exit 1
            }

            local base="${start%.*}."
            local s="${start##*.}"
            local e="${end##*.}"

            for ((i=10#$s; i<=10#$e; i++)); do
              echo "${base}${i}"
            done
          }

          OUT=()
          IFS=',' read -ra PARTS <<< "$INPUT"

          for p in "${PARTS[@]}"; do
            if [[ "$p" == *-* ]]; then
              while read -r v; do OUT+=("$v"); done < <(
                expand_range "${p%%-*}" "${p##*-}"
              )
            else
              OUT+=("$p")
            fi
          done

          if [[ ${#OUT[@]} -eq 0 ]]; then
            echo "::error ::No valid Minecraft versions provided"
            exit 1
          fi

          {
            echo "mc_versions<<EOF"
            for v in "${OUT[@]}"; do echo "$v"; done
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

  build-zip:
    runs-on: ubuntu-22.04
    needs: normalize-tag
    outputs:
      zip_name: ${{ steps.zip.outputs.archive_name }}
    steps:
      - uses: actions/checkout@v4

      - id: zip
        run: |
          name="${GITHUB_REPOSITORY#*/}-${{ needs.normalize-tag.outputs.base_version }}.zip"
          [ -f pack.mcmeta ] || exit 1
          zip -r "$name" pack.mcmeta
          [ -d data ] && zip -r "$name" data
          [ -d assets ] && zip -r "$name" assets
          [ -f pack.png ] && zip -u "$name" pack.png
          echo "archive_name=$name" >> "$GITHUB_OUTPUT"

      - uses: actions/upload-artifact@v4
        with:
          name: datapack-archive
          path: ${{ steps.zip.outputs.archive_name }}

  release:
    runs-on: ubuntu-22.04
    needs: [normalize-tag, build-zip, prepare-versions]
    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: datapack-archive

      - uses: Kira-NT/mc-publish@v3
        with:
          name: ${{ needs.normalize-tag.outputs.base_version }}
          version: ${{ needs.normalize-tag.outputs.base_version }}
          version-type: release
          changelog: auto
          game-versions: ${{ needs.prepare-versions.outputs.mc_versions }}
          files: ${{ needs.build-zip.outputs.zip_name }}
          loaders: vanilla
          github-token: ${{ secrets.GITHUB_TOKEN }}
          modrinth-token: ${{ secrets.MODRINTH_TOKEN }}
          modrinth-id: ${{ vars.MODRINTH_ID }}
